@using Sandbox;
@using Sandbox.UI;
@using System;
@inherits Panel
@namespace Sandbox

<root>
    <div class="message">
        <div class="text">@DisplayedText</div>
    </div>
</root>

@code
{
    public string Speaker { get; set; } = "Unknown";
    public string Text { get; set; } = "...";
    public float Speed { get; set; } = 1f;
    public TimeSince LifeTime { get; set; }

    private string _displayedText;
    public string DisplayedText => $"{Speaker}: {_displayedText}";

    public void Update()
    {
        var count = Text.Count();
        var totalTime = count / Speed;

        if ( LifeTime.Relative < totalTime )
        {
            var progress = LifeTime.Relative / totalTime;
            var charactersToDisplay = Math.Floor(progress * count);

            _displayedText = Text.Substring(0, (int)Math.Clamp(charactersToDisplay, 0, count));
        }
    }

    protected override int BuildHash() => System.HashCode.Combine( DisplayedText );
}
